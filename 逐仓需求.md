**逐仓需求**

1. **概述**

逐仓是一种常见的仓位模式，**其核心价值类似子账户**，通过逐仓用户可以将仓位保证金与账户保证金进行隔离，从而实现风险的隔离。早期逐仓和全仓模式在系统层面采取的是模式切换，系统从数据结构到机制设计都不够灵活。导致模式间相互互斥，同一时间只允许存在一种仓位模式，且在有持仓的情况下不允许切换。大部分二线交易所除了支持分仓有所创新以外，其他都类似币安即不支持逐全仓的持仓切换，自然也不支持并存。逐仓模式相当于把原来的账户沦为钱包，导致逐仓的实际价值有限（币安当前状态）。
同时看到也有较为领先的做法，例如：（OKEX）允许逐仓和全仓的持仓并存，不允许已有持仓仓位模式切换、（bybit）允许当前持仓（即使存在订单）可以随意切换，但不能并存、（火币）允许按照交易对为单位进行保证金隔离。

1. **目标及实现方案**

**Deepcoin目标：**超越当前同行做法，在实现逐仓基本功能的基础上，与现有分仓、合并类功能嫁接，并实现模式间的并存及切换，从而达到各种仓位模式的高度灵活配置。风控上能够继续沿用现有风险管控机制，同时做到即不突破现有风险限额且兼顾多种仓位模式的灵活性需求。用户体验方面做到简单易用，逻辑清晰。
**实现方案：（**待讨论点：调杠杆或高级操作时，是否只要不爆仓就允许操作，不需要补齐未实现亏损**）**

1. **基础逐仓模式：**
   1. 仓位余额：**将逐仓理解成子账户**，建立仓位余额字段，从而将仓位杠杆和有效杠杆分开，即使增加保证金也不会降低每次下单时的杠杆。平仓盈亏剩余的余额默认转入账户余额而非仓位余额
   2. 调整杠杆：指的是调整持仓或者下单杠杆，两者同时联动，存在未成交委托时不可调整杠杆。
      1. 调整杠杆时保证金自动进行增加或释放到仓位余额，仓位保证金率达到对应杠杆下的起始保证金IM
      2. 仓位余额调整到补齐未实现亏损。即：如果调整前增加过保证金，调整杠杆时 仓位保证金+仓位余额恢复到上述水平即可，多余部分退回账户。
   3. 加仓：当仓位存在亏损的时候，加仓时不需要补齐未实现亏损；
   4. 增减保证金：增加的保证金增加到仓位余额，类似为子账户转入余额，同时下单杠杆保持不变。增加保证金时不要求补齐未实现亏损。减少保证金时，不允许将浮盈转出，只允许减少不超过额外增加过的保证金数量。
   5. 自动追加保证金：当仓位触发强平时，将从账户余额中为逐仓的仓位余额转入保证金。追加金额为补齐仓位未实现亏损，即补齐到起始保证金IM所需的金额。账户的avalible是可转出的最大金额，当不足本次追加所需金额时，则自动追加失败。
   6. 强平处理：逐仓的强平价独立计算，且维持保证金MM梯度独立计算，与其他逐仓或全仓不产生任何关联。强平事件发生时，优先执行追加保证金，其次执行撤销委托尝试降低MM要求，再次进行物理降档剥损
   7. 降档剥损：降档剥损后将平仓产生平仓盈亏剩余的余额留在账户余额当中，仓位余额也比例释放到账户余额。
2. **高级模式-并存：**全仓/逐仓并存，逐仓的合仓/分仓并存
   1. 仓位并存：增加逐仓模式下合仓id复用账户id的机制，为全仓及逐仓的合仓分别指定两个默认的持仓id。选择合仓时，全仓和逐仓分别自动累加到默认的两个合仓id仓位上。选择分仓时，面板下单开仓新增仓位，面板下单平仓不允许操作。已有仓位加减仓在仓位上进行操作。
   2. 委托并存：下单时，在委托信息中附带仓位id，从而建立关联关系。
   3. 梯度风控：即实现逐仓的独立，同时又不因为增加逐仓模式而放大原有风险限额，也不改变原有的强平和剥损降档处理。
      1. 交易系统：按照用户整体持仓总量控制IM
      2. 风控系统：全仓部分的MM按照原有机制运行，逐仓的MM单独控制。
3. **高级模式-切换**：全仓与逐仓可相互切换。
   1. 有订单时暂不允许切换：由于APO内在的自上而下一对多逻辑关系和复杂的跨仓位梯度限仓机制，考虑到实际需求，同时为了减少开发成本。约定，有订单时不允许改变仓位，否则该仓位向下所有订单需要修改。有仓位时也不允许改变订单，否则需要改变该订单向上的关联关系。
   2. 全仓切逐仓：允许切换时同时修改杠杆
      1. 条件：切换后全仓部分需保持可用大于0
      2. 风险梯度调整：新逐仓按照独立仓位梯度风控原则计算所需IM起始保证金及MM维持保证金；
      3. 保证金操作：新逐仓的仓位保证金补齐到新杠杆和新梯度限仓下的起始保证金，新逐仓的仓位余额补齐未实现亏损。
   3. 逐仓切全仓：允许切换时同时修改杠杆
      1. 条件：切换后全仓部分需保持可用大于0
      2. 风险梯度调整：新的全仓与原有全仓合并计算所属梯度的IM及MM
      3. 保证金操作：从全仓可用中为新的全仓仓位追加所需的IM起始保证金
4. **合并：**逐仓与逐仓同向合并、同类仓位的多空之间可以合并
   1. 不支持全仓与逐仓合并：因为合并后到底是全仓还是逐仓没有明显合适的默认选择，用户容易操作失误，且跨仓位模式的合并可以通过先切换，后同类仓位合并解决；
   2. 逐仓与逐仓同方向合并：
      1. 条件：合并后不爆仓，原有全仓可用大于0
      2. 风险梯度调整：新逐仓按照独立仓位梯度风控原则计算所需IM起始保证金及MM维持保证金；
      3. 保证金操作：仓位余额合并后不足的部分，从账户余额中补齐
   3. 逐仓仓位的多空合并：任意情况下可合并
      1. 净仓部分的处理：合并后保留数量更多一方的净仓仓位，成本价杠杆保持不变，按照新的独立仓位计算IM和MM
      2. 平仓盈亏剩余的处理：分别计算平仓盈亏剩余，分别转入账户余额 
      3. 手续费：单独设置手续费，双向按照成交部分收费
   4. 全仓仓位的多空合并：任意情况下可合并
      1. 净仓的处理：合并后保留数量更多一方的净仓仓位，成本价杠杆保持不变
      2. 平仓盈亏剩余的处理：分别计算平仓盈亏剩余，分别转入账户余额 
      3. 手续费：单独设置手续费，双向按照成交部分收费
            1. **前端体验：**订单信息中需要明确所属仓位；仓位上增加调整仓位模式的操作功能，与下单面板上的仓位模式调整互不影响。下单面板决定下一次订单所属仓位，仓位上调整决定当前仓位的调整不影响无关联订单和其他仓位；


### 逐仓风控：

1. 对于逐仓风控：委托单冻结资金，在计算风控强平的时候，不作为风控资产处理。同时对于被逐仓触发风控的仓位，需要对该仓位的开仓单/平仓单/止盈止损单/条件单进行撤单；但是对非该逐仓仓位的开仓单/平仓单/止盈止损单/条件单不进行撤单。
2. 对于全仓风控：计算强平价的时候考虑全仓和逐仓的委托冻结，则撤单时候，撤掉全仓全部的委托单；并撤掉逐仓的开仓委托，释放冻结资金；（说明对于全仓风控：计算强平价的时候仅考虑了全仓的委托冻结单，则撤单时候撤掉全仓全部的委托单，不考虑撤掉逐仓的开仓委托）；
3. 资金费率（即资金费用）影响到全仓和逐仓的风控强平，不能因为逐仓的资金费用，导致全仓仓位被强平，因此逐仓仓位的资金费用从该逐仓仓位的持仓保证金扣除。

1. **可减少保证金**

=useMargin-该逐仓仓位的亏损-positioncost/leverage

2. **调整杠杆后的保证金：**

///1. 调整后开仓保证金+未实现亏损 > 当前仓位保证金，则调整后保证金=调整后开仓保证金+未实现亏损
       ///2. 调整后开仓保证金+未实现亏损 < 当前仓位保证金，则调整后保证金=当前仓位保证金

3. **预估强平价**

强平价计算：

- USDT合约的追加后的强平公式：
多仓强平价格 =（合约面值*_合约数量*_开仓价格-持仓保证金）/（合约面值*_合约数量*_（1-强平手续费率-维持保证金率））
空仓强平价格 =（合约面值*_合约数量*_开仓价格+持仓保证金）/（合约面值*_合约数量*_（1+强平手续费率+维持保证金率））
- 币本位合约追加后的的强平公式：
多仓强平价格 =（合约面值*_合约数量*_（1+强平手续费率+维持保证金率））/（合约面值*合约数量/开仓价格+持仓保证金）
空仓强平价格 =（合约面值*_合约数量*_（1-强平手续费率-维持保证金率））/（合约面值*合约数量/开仓价格-持仓保证金）
注释： 
   1. 维持保证金率MM ：取合约表中的维持保证金率
   2. 持仓保证金，含追加保证金后的逐仓持仓保证金UseMargin
