**模拟账户-模拟交易版本**
**背景：**
**模拟交易的三种方案**：
独立环境
独立交易对
同一交易对；
以下针对模拟账户在同一交易对进行模拟交易的应用场景。
**模拟账户的优势：**
接管，不影响盘口流动性
节省带宽，规避异常性操盘
绝对没有插针 不用修复k线图
避免maker单影响真实资金流和利益输送。
在解决模拟交易需求的同时，也解决以下场景问题（以下问题场景都是线上已经遇到过的问题）：
解决**限价目前线上深度插针**（线上已出现两次影响大的投诉，报单止盈止损和条件单止盈止损导致的异常性插针）
异常**接管导致**插针（线上已出现两次重大事情，服务端仍可能突破后出现bug）
**接管价不合理**现象 例如最新价22.522元接管（曹翔那天晚上的异常情况）
解决目前**点差接管价显示在k线上**问题 （目前用户经常投诉我们，成交价不在k线图上显示）
**模拟交易**和模拟账户的问题 
**测试账号**拥有大额资金，进行交易，只能前端APP发版去掉限价委托功能模块 （限价委托会影响盘口，甚至会出现砸盘的异常操作，严重影响真实用户交易和摆盘做市）
**做市策略账户**的交易控制，避免影响盘口
解决**刷单**的点差问题 （即使是配置了点差）
同一个人拥有**不同手续费率**；例如采用API交易手续费率 与采用手动交易的费率不一致；主账户实盘交易和模拟账户的手续费率不一致；
同一个人的不同账户拥有不同的点差组配置；
下单超过最大委托量下单失败的优化
基于此类场景，我们进行整体性的方案设计，以便系统性完整解决：
1. **交易系统开发涉及到模块**
模拟账户支撑模拟交易的应用方式：
采用**原有生产的合约交易对**；而无需另外新上模拟交易对；
模拟交易纯接管不撮合，只是借用了实盘交易对的最新价触发接管机制，对实盘线上完全不产生影响。
主要对应以下子模块功能的实现：
模拟账户 ：独立账户类型——【已实现】   
模拟账户配置点差组————【已实现】
模拟账户走独立点差组——【已实现】   
模拟账户： 配置交易模式—— 【待开发】
模拟账户： 配置手续费率组—— 【待开发】  
模拟账户：接管账户独立 ——【需配置并开发】
模拟账户市价限价都点差接管 ——需开发
支持限价接管；普通市价和条件单触发市价接管已支持
另外衍生出底层异常性和稳定性的需求：
点差接管价的异常性判断
点差接管的模块解耦
另外，为了减少用户因为最大下单量下单失败或者投诉的问题，我们新增处理：
若为点差用户，可以不限制最大下单量（因为点差用户不会冲击做市盘口的订单薄）；
通过以上一个个子模块功能的拼装组合，来解决线上问题和实现增量场景应用。
2. **交易系统开发涉及到模块**
满足场景需求，改造模块：
![](https://cdn.nlark.com/yuque/0/2023/png/13006229/1693145197881-c3ba213b-548e-40b3-9e4a-91d85f503557.png#)
2.1 **设置交易模式：**
在t_account表中新增字段：
  TradingModel char(1) NOT NULL DEFAULT '0' COMMENT '交易模式
     类型枚举值：
0.先撮合后接管(含全撮合不配置点差组）
1.maker和taker都接管，没有撮合纯的接管
说明：模拟账户配置成：纯接管模式
2.2 **模拟账户： 配置手续费率组**
基于accout维度
FeeGrade char(8) DEFAULT NULL COMMENT
  优先accout维度；然后member维度
2.3 **模拟账户：接管账户独立  + 对应账户类型的接管账户**
接管账户根据被接管账户的账户类型AccountType来，若被接管账户有设置AccountType，且接管账户有配置该账户类型AccountType的接管账户，则被接管的资产进入到对应的账户类型AccountType的接管账户。

| 场景 | 用户账户的AccountType | 接管账户的AccountType | 结果 |  |
| --- | --- | --- | --- | --- |
| 用户下单交易 | 模拟账户=mock | 配置了对应mock类型的接管账户 | 接管进入mock类型的接管账户中 |  |
| 用户下单交易 | 未配置 | 配置了对应mock类型的接管账户 | 接管进入默认的接管账户中 |  |
|  |  |  |  |  |

特别说明：接管账户中资产处理的问题。
2.4 **模拟账户市价限价都点差接管 **
对于先撮合后接管模式和纯接管模式（用户有配置点差组）
若限价单的委托价>=最新价（即符合撮合规则），则
若有配置了点差组，且委托价大于等于最新价，则先撮合，剩余未撮合且大于最新价的限价委托单进行接管；
若限价单的委托价< =最新价（即不符合撮合规则），则转为普通挂单，不进行接管指令；
说明：
判断规则是限价单的委托价>=最新价，是因为最新价必须处于盘口第一档价格（委卖一委买一）范围内；
若用户未配置了点差组，则仅进行撮合交易。
3. **影响面分析：服务层需要重点考虑**
**重点考虑和排查**：**避免生产资金和****模拟资金****混用**
资金费用单独考虑
分润的预扣除：避免
甩单
手续费
4. **影响面分析**

|  |  | 真实/模拟是否混 | 解决方案（措施） | 平台影响否 |
| --- | --- | --- | --- | --- |
|  | 预分润 | 是 | 模拟账户不能作为模拟跟单 |  |
|  | 分润结算 | 是 | -- |  |
|  | 强平接管 | 是 | 正常强平：
运营统计剔除模拟账户的 |  |
|  | 体验金 | -- |  |  |
|  | 资金费用 | 是 | 不进行资金费结算
**模拟账户资金费用：独立结算**
资产列表：明细 净仓仓位 |  |
|  | 手续费
结算-手续费 | 是 | 设置手续费率=0 |  |
|  | 资金划入 | 是 | 服务端控制，不让划转 |  |
|  | 资金划出 | 是。 | 服务端控制，不让划转 |  |
|  | 平仓盈亏 | 是 | 运营统计剔除模拟账户的 |  |
|  | 结算-平仓盈亏 |  | -- |  |
|  | 结算-资金费用 |  | -- |  |
|  |  |  |  |  |
|  |  |  |  |  |

账户类型：
**模拟账户** 
测试内部账户 
主账户
体验金账户
比赛账户
自定义账户
5. **点差接管的模块解耦**
**背景：**
目前点差模块做成了交易撮合的前置模块，影响到了交易系统整体模块设计思路，避免模块间相互影响。
**解决方案**：
通过点差模块做成参数配置的开关，实现点差模块的系统解耦。
为了保持系统稳健性和模块化设计规则，建议在serviceconfig中新增配置：
具体接口配置
/action/v1.0/SendInsUpd/ServiceConfig
{"ConfigName":"IsCFDTrade","Index1":"default","Index2":"default","ConfigValue":1}
**配置规则：**
IsCFDTrade点差交易配置为1，则表示开启点差交易模块；
IsCFDTrade点差交易配置为0 或者默认不设置改配置，则交易撮合系统不走点差交易模块。
6. **接管点差价的异常性判断和处理**
6.1 **线上问题背景**
![](https://cdn.nlark.com/yuque/0/2023/png/13006229/1693145198119-aa7dfbc2-07f3-4c1f-9aa3-1926e0733576.png#)
条件单 ： 委托量 triggerPrice=为空
轮询触发机制：服务端处理
 触发后改单（条件单的改单    triggerPrice=22.0,  lastprice =23————触发委托单
普通委托单  price= triggerPrice +点差 =22.15 
接管价明显低于最新价lastprice =23，让用户形成明显套利行为，该用户多达8万USDT的讨论
为了避免异常性的套利行为出现，我们需要比较点差接管和最新价：
我们将线上问题进一步简化举例：
  点差接管价price= triggerPrice +点差 =22.15 ，则 点差接管买入遇到以下两种场景：
**场景1：正常场景**
20.05  10
20.01  10
最新价 lastprice=20
盘口的两个档位吃掉 20 张； 剩余80张就接管
**场景2：**
23.05  10
23.01  10
最新价 lastprice=23
盘口的两个档位吃掉 0 张； 剩余100张就接管 ————明显不可以接管，因为接管后就形成比较大的套利空间。
6.2 **解决方案：**
对于交易模式（对于以下两种接管模式都应该支持）：
纯接管模式，
先撮合后接管模式
点差接管价格都必须满足如下条件：
点差接管价格，无论是普通委托形成的市价下单，还是限价下单；还是条件委托形成的市价下单，还是限价下单；点差接管价都必须满足以下条件：
对于买盘委托 ：计算点差基准价格-触发价(最新价) + 点差 >最新价  
    异常： 对于买盘委托 ：点差基准价格 + 点差 20.15 <最新价 23   则不应该接管，应该仅仅下单委托形成挂单。
对于卖盘委托 ：计算点差基准价格-触发价(最新价) - 点差 20.15 <最新价 23 
    异常： 对于卖盘委托 ：点差基准价格 - 点差 25 > 最新价 23   则不应该接管，应该仅仅下单形成挂单。
**分情况讨论**：
对于条件单形成的点差价
对于买盘委托 ：触发价+ 点差 >最新价
    异常：1、 对于买盘委托 ：触发价 + 点差 20.15 <最新价 23   则不应该接管，应该仅仅下单。
对于卖盘委托 ：触发价 - 点差 20.15 <最新价 23 
    异常：2、 对于卖盘委托 ：触发价 - 点差 25 > 最新价 23   则不应该接管，应该仅仅下单。
对于普通委托单形成的点差价
对于买盘委托 ：计算点差基准价格-最新价+ 点差 >最新价
    异常：1、 对于买盘委托 ：基准价(最新价) + 点差 20.15 < 最新价 23   则不应该接管，应该仅仅下单。
对于卖盘委托 ：计算点差基准价格-最新价  - 点差 20.15 < 最新价 23 
    异常：2、 对于卖盘委托 ：基准价(最新价) - 点差 25 > 最新价 23   则不应该接管，应该仅仅下单。
特别说明：
点差接管价（基准价+点差价）： 1）符合撮合规则范围内的盘口吃到； 2)未撮合的剩余部分，进行接管；
对于限价委托的点差接管对应的基准价：
采用最新价作为基准价也是有一定的问题，显示应该还是显示用户手动填入的限价；但是点差接管价=最新价+点差价
例如：最新价=10000  用户限价委托价12000，点差接管价的点差率为0.1%，则买点差价=最新价*（1 + 0.1%）=10010，成交后，例如历史委托价=12000.
**测试执行：**
服务端写入的异常触发逻辑，导致交易系统触发下单并接管
7. **解决目前点差接管价显示在k线上问题 **
背景：
目前用户经常投诉我们，成交价不在k线图上显示。
解决方案：
放开点差接管价不在K线图上的限制。
目前点差接管价异常兜底，避免插针的现象已经完整处理。所以可以放开限制，将点差接管价画到k线图上了。
8. **点差接管不限制最大下单量**
背景：
最大委托量的存在目的：为了避免非常的单子直接封盘砸盘，对盘口造成比较大的冲击，进而影响真实用户；
同时由于最大委托量的存在，
因为有点差接管的存在，不会对盘口造成大的冲击，
解决方案：
若为点差用户，可以不限制最大下单量；
===============================备注：
**模拟账户走独立点差组**
基于accout维度的独立点差接管（优先account，后member）
  CFDType char(1) DEFAULT NULL COMMENT '点差接管类型(0:先撮合后点差接管;1:只撮合不点差接管;2:不撮合只点差接管;)',
